<!doctype HTML>
<html>
<!-- Copyright 2013 by Bill Roy.  Use under MIT License. -->
<head>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
<script src="http://code.angularjs.org/1.1.5/angular.js"></script>
<script src="angular-ui.js"></script>

<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.1.1/css/bootstrap.min.css" rel="stylesheet"/>


<style type='text/css'>
body {
    background-color: black;
}
.notebook {
    background-color: lightgray;
    width: 2048px;
    height:2048px;
}
.note {
    position: absolute;
	text-align: left;
	cursor: move;
}
.titlebar {
    border-style: solid;
    border-width: 1px;
    border-radius: 12px;
}
.notetitle {
	font: bold .8em;
    font-weight: bold;
	text-align: left;
}
.notebody {
    margin: -0.1em 0.5em 0 0.5em;
    padding: 0.5em 1em 1em 1em;
    background: white;
    border-style: solid;
    border-width: 1px;
    border-radius: 3px 3px 6px 6px;
}
.over {
    border: 1px red dashed;
}
input[type=text] {
    border-radius: 6px;
    border: 0;
}
textarea {
    border-radius: 6px;
    border: 0;
}
.button {
    color: white !important;
    background: black;
    font-size: 0.8em;
    border-radius: 3px;
    cursor:pointer;
}
.buttons {
    margin: 0 2em 0 2em;
}
.noteMenu {
    position: absolute;
    background: white;
    color: black
    z-index: 10000;
    border: 1px solid black;
    border-radius: 4px;
}
.noteMenu div {
    padding: 0 .25em 0 .25em;
    cursor:default;
}
.noteMenu div.highlight {
    background: blue;
    color: white;
}
div.rule {
    width: 90%;
    height: 2px;
    border: 0;
    background-color: lightgray;
    margin-top: 6px;
    margin-bottom: 6px;
}
div.commandbar {
    background:darkgray;
}
div.commandbar>input {
    width: 512px;
}
p {
    margin-bottom: 0em;
}
</style>
</head>
<body ng-app='NoteSoup'>

<div ng-controller='NotebookController' class='notebook'
    droppable='true'
    ui-event='{
        dragstart:"dragstart($event)", 
        drag:"drag($event)",
        dragover:"dragover($event)",
        dragenter:"dragenter($event)",
        dragleave:"dragleave($event)",
        drop:"drop($event)",
        dragend:"dragend($event)"
    }'>

    <div class="commandBar">
        <div>
            <form name='newNoteEntry' ng-submit='addNoteFromForm()'>
                <input type='text' name='newNoteText' 
                    ng-style='{width:"80%"}'
                    ng-model='newNoteText'/>
            </form>
        </div>
    </div>

    Notes: <div ng-repeat='note in notes'>{{note}}</div>

    <div class='note' ng-repeat='note in notes' id='note_{{note.i}}'
        ng-style='{color:"{{note.c}}", left:"{{note.x}}px", top:"{{note.y}}px", width:"{{note.w}}px"}'
        draggable='true'
        ui-event='{
            dragstart:"dragstart($event)", 
            drag:"drag($event)",
            dragover:"dragover($event)",
            dragenter:"dragenter($event)",
            dragleave:"dragleave($event)",
            drop:"drop($event)",
            dragend:"dragend($event)"
        }'>
        <div class='titlebar'
            ng-right-click='showNoteMenu(note, $event)'
            ng-dblclick='editTitle(note)'
            ng-style='{background:"{{note.b}}", width:"{{note.w}}px"}'>
            <span style='cursor:pointer' ng-click='toggleText(note)'>
                <span ng-hide='note.d'>&nbsp;&bull;</span>
<!--
                <svg ng-hide='note.d' width='12' height='12'>
                    <path d='M3,3L7,6L3,9Z'
                        style='fill:#000; stroke:#000;'/>
                </svg>
-->
                <svg ng-show='note.d' width='12' height='12'>
                    <path d='M3,5L6,9L9,5Z'
                        style='fill:#000; stroke:#000;'/>
                </svg>
            </span>
            <span class='notetitle' 
                ng-hide='note._editingTitle'>{{note.n}}
            </span>
            <span ng-show='note._editingTitle'>
                <input type='text' name='noteTitle' ng-style='{width:"80%"}'
                    ng-model='note.n'>
                <span class='buttons'>
                    <span class='button' ng-click='cancelEditTitle(note)'>&nbsp;Cancel&nbsp;</span>
                    <span class='button' ng-click='saveTitle(note)'>&nbsp;Save&nbsp;</span>
                </span>
            </span>
        </div>
        <div ng-show='note.d' class='notebody' 
            ng-right-click='showNoteMenu(note, $event)'
            ng-dblclick='editText(note)'>
            <div ng-show='note.d&&!note._editingText' ng-bind-html-unsafe='renderBody(note)'></div>
            <div ng-show='note.d&&note._editingText'>
                <textarea name='noteBody' ng-style='{width:"95%"}'
                    ng-model='note.t'></textarea>
                <span class='buttons'>
                    <span class='button' ng-click='cancelEditText(note)'>&nbsp;Cancel&nbsp;</span>
                    <span class='button' ng-click='saveText(note)'>&nbsp;Save&nbsp;</span>
                </span>
            </div>
        </div>
    </div>

    <div class='noteMenu' ng-show='showingNoteMenu'
        ng-mouseleave='hideMenu()'>
        <div ng-repeat='item in noteMenu'>
            <div ng-hide='item.s'
                ng-click='{{item.x}}'
                ng-class='overclass'
                ng-mouseenter='overclass="highlight"'
                ng-mouseleave='overclass=""'>{{item.t}}
            </div>
            <div ng-show='item.s' class='rule'></div>
    </div>

</div>

<script type='text/javascript'>
/* Note attributes:
    a b:background c:color d:displayText e f g h:height i:id
    j k l m n:title o p q r s t:text u v w:width x:left y:top z:zindex
s:selected
e:error editing editable
o:opacity
*/

window.app = angular.module('NoteSoup', ['ui']);

// from http://jsfiddle.net/bcaudan/vTZZ5/
app.directive('ngRightClick', function($parse) {
    return function(scope, element, attrs) {
        var fn = $parse(attrs.ngRightClick);
        element.bind('contextmenu', function(event) {
            scope.$apply(function() {
                event.preventDefault();
                fn(scope, {$event:event});
            });
        });
    };
});

function NotebookController($scope, $timeout, $window) {

    var sampleNotes = [
        {i:'n1', x:100, y:100, n:'first note', t:'text of first note'},
        {i:'n2', x:200, y:200, n:'second note', t:'text of second note', c:'blue'},
        {i:'n3', x:300, y:300, n:'third note', t:'text of third note', b:'lightgreen'},
        {i:'n4', x:400, y:400, n:'fourth note', t:'text of fourth note', b:'blue', c:'white'},
        {i:'n5', x:500, y:500, n:'fifth note', t:'text of fifth note', b:'lightgreen', c:'lightgray'},
        {i:'n6', x:600, y:600, n:'sixth note', t:'text of sixth note', b:'magenta'}
    ];

    $scope.appName = 'notesoup'
    $scope.path = 'inbox';
    $scope.notes = {};
    $scope.defaultNote = {
        w:150, b:'lightgreen', c:'black',
    };

    $scope.nextNoteId = 1;
    $scope.newNoteId = function() {
        while ($scope.notes.hasOwnProperty('N' + $scope.nextNoteId)) {
            $scope.nextNoteId++;
        }
        return 'N' + $scope.nextNoteId;
    };

    $scope.updateNote = function(note) {
        if (!$scope.notes.hasOwnProperty(note.i)) {
            var newNote = {};
            newNote.__proto__ = $scope.defaultNote;
            $scope.notes[note.i] = newNote;
        }
        angular.extend($scope.notes[note.i], note);

        var id = parseInt(note.i.slice(1));
        if (id > $scope.nextNoteId) $scope.nextNoteId = id + 1;
    };

    $scope.loadSampleNotes = function() {
        angular.forEach(sampleNotes, function(sampleNote, index) {
            $scope.updateNote(sampleNote);
        });
    };

    // localStorage key for a note
    $scope.getKey = function(note) {
        return [$scope.appName, $scope.path, note.i].join('/');
    };
    
    // load notes from localStorage
    $scope.loadNotes = function() {
        var allKeys = Object.keys(localStorage);
        angular.forEach(allKeys, function(key, index) {
            var keyParts = key.split('/');
            if (keyParts[0] != $scope.appName) return;
            if (keyParts[1] != $scope.path) return;
            var note = JSON.parse(localStorage[key]);
            $scope.updateNote(note);
        });
    };
    //$scope.loadSampleNotes();
    $scope.loadNotes();

    $scope.saveNote = function(note) {
        var key = $scope.getKey(note);
        try {
            localStorage.setItem(key, JSON.stringify(note));
        } catch(e) {
            alert('ERROR: Could not save note!  Increase LocalStorage!');
        }
    };

    $scope.deleteNote = function(note) {
        localStorage.removeItem($scope.getKey(note));
        delete $scope.notes[note.i];
    };
    
    $scope.deleteAllNotes = function() {
        if (!confirm('Really delete all notes?')) return;
        angular.forEach($scope.notes, function(note, index) {
            $scope.deleteNote(note);
        });
        $scope.nextNoteId = 1;
    };

    $scope.toggleText = function(note) {
        if (note.d) delete note.d;
        else note.d = 1;
        $scope.saveNote(note);
    };

    //$scope.getNote = function(id, callback) {
    //   if ($scope.notes.hasOwnProperty(id)) 
    //        callback($scope.notes[id]);
    //};

    $scope.runClock = function() {
        $scope.notes['n3'].n = new Date();
        $scope.notes['n2'].x = $scope.notes['n2'].x + Math.floor((Math.random()*20)-10); 
        $timeout($scope.runClock, 1000);
    }
    //$scope.runClock();

    // drag and drop
    $scope.stopEvent = function(event) {
        var e = event.originalEvent;
        if (e.preventDefault) {
            e.preventDefault();     // Necessary. Allows us to drop.
        }
    };
    $scope.draggedNoteElement = null;
    $scope.draggedNoteId = null;
    $scope.dragstart = function(event) {
        var e = event.originalEvent;
        $scope.dragOffsetX = e.offsetX;
        $scope.dragOffsetY = e.offsetY;
        $scope.draggedNoteElement = e.target;
        var id = $scope.draggedNoteElement.id;
        if (!id.match(/^note_/)) alert('Bogus note id');
        $scope.draggedNoteId = id.slice(5);
        $scope.draggedNoteElement.style.opacity = 0.4;
        //console.log('dragstart', event);
    };
    $scope.dragover = function(event) {
        $scope.stopEvent(event);
        //console.log('dragover', event);
    };
    $scope.dragenter = function(event) {
        // this / e.target is the current hover target.
        //event.originalEvent.target.classList.add('over');
        //console.log('dragenter:', event);
    };
    $scope.dragleave = function(event) {
        //event.originalEvent.target.classList.remove('over');
        //console.log('dragleave', event);
    };
    $scope.drag = function(event) { 
        //console.log('drag', event); 
    };
    $scope.drop = function(event) {
        $scope.stopEvent(event);
        $scope.draggedNoteElement.style.opacity = 1.0;
        var e = event.originalEvent;
        var target = e.target;
        var id = target.id;
        if (!id.match(/^note_/)) {  // drop on workspace
            //console.log('drop on workspace');
            // update note position
            // BUG: this updates the scope, but not the location of the notes
            // TODO: handle page scroll offset
            $scope.notes[$scope.draggedNoteId].x = e.x - $scope.dragOffsetX + $window.pageXOffset;
            $scope.notes[$scope.draggedNoteId].y = e.y - $scope.dragOffsetY + $window.pageYOffset;

            // TODO: why doesn't Angular move the element when the model updates?
            angular.element($scope.draggedNoteElement).css({
                left: $scope.notes[$scope.draggedNoteId].x,
                top: $scope.notes[$scope.draggedNoteId].y
            });
            $scope.saveNote($scope.notes[$scope.draggedNoteId]);
        }
        else {        
            // TODO: drop on note
            return;
            var droppedNoteId = id.slice(5);
            console.log('dropped on note', droppedNoteId);
            $scope.notes[droppedNoteId].t += [
                '<p>', $scope.notes[$scope.draggedNoteId].n, '</p>\n',
                '<p>', $scope.notes[$scope.draggedNoteId].t, '</p>'
            ].join('');
        }
        return false;
    };
    $scope.dragend = function(event) { 
       // this/e.target is the source node.
        var e = event.originalEvent;
        //console.log('dragend', event);  
        return false;
    };

    $scope.nextX = 24;
    $scope.nextY = 24;
    $scope.nextIncrement = 24;
    $scope.nextXPos = function() {
        $scope.nextX += $scope.nextIncrement;
        return $scope.nextX;
    };
    $scope.nextYPos = function() {
        $scope.nextY += $scope.nextIncrement;
        return $scope.nextY;
    };

    // add note via command bar
    $scope.addNoteFromForm = function() {
        // called from commandBar form, so 'this' is $scope here
        if (this.newNoteText[0] == '.') {           // command
            try {
                eval('$scope.' + this.newNoteText.slice(1));
            } catch(e) {
                console.log('Error:', e);
            }
            this.newNoteText = '';
        }
        else if (this.newNoteText[0] == '{') {     // json note
            var newNote = JSON.parse(this.newNoteText);
            newNote.i = $scope.newNoteId();
            $scope.updateNote(newNote);
            $scope.saveNote($scope.notes[newNote.i]);
            this.newNoteText = '';            
        }
        else {
            if (this.newNoteText.length == 0) return;
            var lines = this.newNoteText.split('/');
            var newNote = {
                i: $scope.newNoteId(),
                n: lines[0],
                x: $scope.nextXPos(),
                y: $scope.nextYPos()
            };
            if (lines.length > 1) {
                // html in the body: replace the slashes
                if (lines[1][0] == '<') newNote.t = lines.slice(1).join('/');
                else newNote.t = lines.slice(1).join('\n');
                newNote.d = 1;
            }
            this.updateNote(newNote);
            this.saveNote(this.notes[newNote.i]);
            this.newNoteText = '';
        }
    };

    // edit title of note
    $scope.editTitle = function(note) {
        note._saved_title = note.n;
        note._editingTitle = 1;
    };
    $scope.cancelEditTitle = function(note) {
        note.n = note._saved_title;
        delete note._saved_title;
        delete note._editingTitle;
    };
    $scope.saveTitle = function(note) {
        delete note._saved_title;   // could keep this for undo
        delete note._editingTitle;
        $scope.saveNote(note);
    };

    // edit text of note
    $scope.editText = function(note) {
        note._saved_text = note.t;
        note.d = 1;
        note._editingText = 1;
    };
    $scope.cancelEditText = function(note) {
        note.t = note._saved_text;
        delete note._saved_text;
        delete note._editingText;
    };
    $scope.saveText = function(note) {
        delete note._saved_text;   // could keep this for undo
        delete note._editingText;
        $scope.saveNote(note);
    };

    $scope.renderBody = function(note) {
        if (!note.t) return '';
        if (note.t[0] == '<') return note.t;    // html body
        var lines = note.t.split('\n');
        return '<p>' + lines.join('</p>\n<p>') + '</p>';    // else htmlify body
    };

    $scope.noteMenu = [
        {t:'Edit Note Body',    x:'editText(selectedNote);hideMenu()'},
        {t:'Edit Note Title',   x:'editTitle(selectedNote);hideMenu()'},
        {s:1},
        {t:'Delete Note',       x:'deleteNote(selectedNote);hideMenu()'},
        {t:'Delete all notes',  x:'deleteAllNotes();hideMenu()'},
    ];

    $scope.showNoteMenu = function(note, event) {
        $scope.selectedNote = note;
        $scope.showingNoteMenu = true;
        angular.element('.noteMenu').css({
            left: event.clientX,
            top: event.clientY
        });
    };
    
    $scope.hideMenu = function() {
        delete $scope.showingNoteMenu;
        delete $scope.selectedNote;
    };

};
</script>

</body>
</html>
