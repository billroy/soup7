<!doctype HTML>
<html>
<!-- Copyright 2013 by Bill Roy.  Use under MIT License. -->
<head>
<title>note soup</title>
<script src='http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js'></script>
<script src='http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js'></script>
<script src='http://code.angularjs.org/1.1.5/angular.min.js'></script>
<script src='js/ui-utils/modules/event/event.js'></script>
<script src='js/angular-bootstrap-colorpicker/js/bootstrap-colorpicker-module.js'></script>

<link href='http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css' 
    rel='stylesheet'/>
<link href='js/angular-bootstrap-colorpicker/css/colorpicker.css' rel='stylesheet'/>

<style type='text/css'>
body {
    background-color: black;
}
.notebook {
    width: 2048px;
    height:2048px;
}
.note {
    position: absolute;
	text-align: left;
	cursor: move;
}
.titlebar {
    border-style: solid;
    border-width: 1px;
    border-radius: 12px;
}
.notetitle {
	font-size: 100%;
    font-weight: bold;
	text-align: left;
}
.notebody {
    font-size: 80%;
    margin: -0.1em 0.5em 0 0.5em;
    padding: 0.5em 1em 1em 1em;
    background: white;
    border-style: solid;
    border-width: 1px;
    border-radius: 3px 3px 6px 6px;
}
.over {
    border: 1px red dashed;
}
input[type=text] {
    border-radius: 6px;
    border: 0;
}
textarea {
    border-radius: 6px;
    border: 0;
}
.button {
    color: white !important;
    background: black;
    font-size: 0.8em;
    border-radius: 3px;
    cursor:pointer;
}
.buttons {
    margin: 0 2em 0 2em;
}
.noteMenu {
    position: absolute;
    background: white;
    color: black;
    z-index: 10000;
    border: 1px solid black;
    border-radius: 4px;
}
.noteMenu div {
    margin: .25em 0 .25em 0;
    padding: 0 .25em 0 .25em;
    cursor:default;
}
.noteMenu div.highlight {
    background: blue;
    color: white;
}
div.rule {
    width: 90%;
    height: 2px;
    border: 0;
    background-color: lightgray;
    margin-top: 6px;
    margin-bottom: 6px;
}
.commandBar {
    background: black;
    color: white;
    width: 1024px;
    height: 42px;
    border: 1px solid lightgray;
    border-radius: 6px;
    margin: 0 0 0 0;
}
.logo {
    float: left;
    text-align: center;
    width: 96px;
    margin: 12px 0 0 0;
}
.textInput {
    background: white;
    width: 512px;
    color: blue;
    float: left;
    margin: 6px 0 0 6px;
    height: 24px;
}
.workspaceSelector {
    float: left;
    font-size: 0.8em;
    width: 96px;
    height: 18px;
    margin: 1em 1em 0 1em;
}
p {
    margin-bottom: 0em;
}
.colorPickerContainer {
    position: absolute;
    z-index: 15000;
}
</style>
</head>
<body ng-app='NoteSoup'>

<div ng-controller='NotebookController' class='notebook'
    droppable='true'
    ng-style='workspaceStyle()'
    ui-event='{
        dragstart:"dragstart($event)", 
        drag:"dragging($event)",
        dragover:"dragover($event)",
        dragenter:"dragenter($event)",
        dragleave:"dragleave($event)",
        drop:"drop($event)",
        dragend:"dragend($event)"
    }'>

    <div class='commandBar'>
        <div class='logo'>Note Soup</div>
        <select class='workspaceSelector' name='workspace' 
            ng-model='selectedWorkspace'
            ng-options='w for w in workspaces'></select>
        <form name='commandEntry' ng-submit='addNoteFromForm()'>
            <input type='text' name='newNoteText' class='textInput' ng-model='newNoteText'/>
        </form>
    </div>

    <div ng-show='workspace.debug'>
        Workspace: {{workspace}}
        Notes: <div ng-repeat='note in notes'>{{note}}</div>
        Color: {{pickedColor}}
        Resize: {{drag.resize}}
        Picker: {{isColorPickerVisible()}}
    </div>

    <div class='note' ng-repeat='note in notes' id='note_{{note.i}}'
        ng-style='noteStyle(note)'
        draggable='true'
        ui-event='{
            dragstart:"dragstart($event)", 
            drag:"dragging($event)",
            dragover:"dragover($event)",
            dragenter:"dragenter($event)",
            dragleave:"dragleave($event)",
            drop:"drop($event)",
            dragend:"dragend($event)"
        }'>
        <div class='titlebar'
            ng-right-click='showNoteMenu(note, $event)'
            ng-mouseover='mouseover(note, $event)'
            ng-mouseleave='mouseleave(note, $event)'
            ng-style='noteTitleStyle(note)'>
            <span style='cursor:pointer' ng-click='toggleText(note)'>
                <svg ng-hide='note.d' width='12' height='12'>
                    <circle cx='8' cy='7' r='2' 
                        ng-style='{fill:note.c, stroke:note.c}'/>
                </svg>
<!--
                <svg ng-hide='note.d' width='12' height='12'>
                    <path d='M4,3L8,6L4,9Z'
                        style='fill:#000; stroke:#000;'/>
                </svg>
-->
                <svg ng-show='note.d' width='12' height='12'>
                    <path d='M4,5L7,9L10,5Z'
                        ng-style='{fill:note.c, stroke:note.c}'/>
                </svg>
            </span>
            <span class='notetitle' 
                ng-dblclick='editTitle(note)'
                ng-hide='note._editingTitle'>{{note.n}}
            </span>
            <span ng-show='note._editingTitle'>
                <input type='text' name='noteTitle' ng-style='{width:"80%"}'
                    ng-model='note.n'>
                <span class='buttons'>
                    <span class='button' ng-click='cancelEditTitle(note)'>&nbsp;Cancel&nbsp;</span>
                    <span class='button' ng-click='saveTitle(note)'>&nbsp;Save&nbsp;</span>
                </span>
            </span>
        </div>
        <div ng-show='note.d' class='notebody' 
            ng-right-click='showNoteMenu(note, $event)'
            ng-mouseover='mouseover(note, $event)'
            ng-mouseleave='mouseleave(note, $event)'
            ng-dblclick='editText(note)'>
            <div ng-show='note.d&&!note._editingText' ng-bind-html-unsafe='renderBody(note)'></div>
            <div ng-show='note.d&&note._editingText'>
                <textarea name='noteBody' ng-style='{width:"95%"}'
                    ng-model='note.t'></textarea>
                <span class='buttons'>
                    <span class='button' ng-click='cancelEditText(note)'>&nbsp;Cancel&nbsp;</span>
                    <span class='button' ng-click='saveText(note)'>&nbsp;Save&nbsp;</span>
                </span>
            </div>
        </div>
    </div>

    <div class='noteMenu' ng-show='showingNoteMenu'
        ng-mouseleave='hideMenu()'>
        <div ng-repeat='item in noteMenu'>
            <div ng-hide='item.s'
                ng-click='{{item.x}}'
                ng-class='overclass'
                ng-mouseenter='overclass="highlight"'
                ng-mouseleave='overclass=""'>{{item.t}}
            </div>
            <div ng-show='item.s' class='rule'></div>
        </div>
    </div>

    <div class='colorPickerContainer' ng-show='showingColorPicker'>
        <span colorpicker='hex' 
            colorpicker-position='right' 
            class='colorPickerPlaceholder span2' ng-model='pickedColor'></span>
    </div>
</div>

<!-- drag image -->
<svg class='dragImage' width='12' height='12'>
    <path d='M9,3L9,9 M3,6L9,6 M5,3L9,6 M5,9L9,6'
        style='stroke:#000;'/>
</svg>

<script type='text/javascript'>
/* Note attributes:
    a b:background c:color d:displayText e f g h:height i:id
    j k l m n:title o p q r s t:text u v w:width x:left y:top z:zindex
s:selected
e:error editing editable
o:opacity
*/

window.app = angular.module('NoteSoup', ['ui.event', 'colorpicker.module']);

// from http://jsfiddle.net/bcaudan/vTZZ5/
app.directive('ngRightClick', function($parse) {
    return function(scope, element, attrs) {
        var fn = $parse(attrs.ngRightClick);
        element.bind('contextmenu', function(event) {
            scope.$apply(function() {
                event.preventDefault();
                fn(scope, {$event:event});
            });
        });
    };
});

function NotebookController($scope, $timeout, $window) {

    var sampleNotes = [
        {i:'n1', x:100, y:100, n:'first note', t:'text of first note'},
        {i:'n2', x:200, y:200, n:'second note', t:'text of second note', c:'blue'},
        {i:'n3', x:300, y:300, n:'third note', t:'text of third note', b:'lightgreen'},
        {i:'n4', x:400, y:400, n:'fourth note', t:'text of fourth note', b:'blue', c:'white'},
        {i:'n5', x:500, y:500, n:'fifth note', t:'text of fifth note', b:'lightgreen', c:'lightgray'},
        {i:'n6', x:600, y:600, n:'sixth note', t:'text of sixth note', b:'magenta'}
    ];

    $scope.setDebug = function(value) {
        $scope.workspace.debug = value;
        $scope.saveWorkspace();
    };

    $scope.appName = 'notesoup'
    $scope.path = 'inbox';
    $scope.notes = {};
    $scope.workspaceId = 'Workspace';

    $scope.workspace = {
        i: $scope.workspaceId,
        debug: false,
        b:'lightgray',
        defaultNote: {
            w:150, b:'lightyellow', c:'black',
        }
    };
    
    $scope.workspaceStyle = function() {
        return {background: $scope.workspace.b};
    };

    $scope.noteStyle = function(note) {
        return {
            color: note.c,
            'border-color': note.c,
            left: note.x, 
            top: note.y, 
            width: note.w,
            cursor: note._resizable ? 'col-resize' : 'move'
        }
    };

    $scope.noteTitleStyle = function(note) {
        return {
            background: note.b
        }
    };

    $scope.nextNoteId = 1;
    $scope.newNoteId = function() {
        while ($scope.notes.hasOwnProperty('N' + $scope.nextNoteId)) {
            $scope.nextNoteId++;
        }
        return 'N' + $scope.nextNoteId;
    };

    $scope.updateNote = function(note) {
        if (!$scope.notes.hasOwnProperty(note.i)) {
            var newNote = {};
            newNote.__proto__ = $scope.workspace.defaultNote;
            $scope.notes[note.i] = newNote;
        }
        angular.extend($scope.notes[note.i], note);

        var id = parseInt(note.i.slice(1));
        if (id > $scope.nextNoteId) $scope.nextNoteId = id + 1;
    };

    $scope.loadSampleNotes = function() {
        angular.forEach(sampleNotes, function(sampleNote, index) {
            $scope.updateNote(sampleNote);
        });
    };

    // localStorage key for any object with a .i field
    $scope.getKey = function(obj) {
        return [$scope.appName, $scope.path, obj.i].join('/');
    };
    
    // load notes from localStorage
    $scope.loadNotes = function() {
        var allKeys = Object.keys(localStorage);
        angular.forEach(allKeys, function(key, index) {
            var keyParts = key.split('/');
            if (keyParts[0] != $scope.appName) return;
            if (keyParts[1] != $scope.path) return;
            if (keyParts[2][0] == 'N') {
                var note = JSON.parse(localStorage[key]);
                $scope.updateNote(note);
            }
            else if (keyParts[2] == $scope.workspaceId) {
                $scope.workspace = JSON.parse(localStorage[key]);
            }
            else { 
                alert('Deleting unexpected item in workspace storage:' + key + '/' + localStorage[key]); 
                localStorage.removeItem(key);
            }
        });
    };
    //$scope.loadSampleNotes();
    $scope.loadNotes();

    $scope.saveNote = function(note) {
        var key = $scope.getKey(note);
        try {
            localStorage.setItem(key, JSON.stringify(note));
        } catch(e) {
            alert('ERROR: Could not save object!  Increase LocalStorage!');
        }
    };

    $scope.deleteNote = function(note) {
        localStorage.removeItem($scope.getKey(note));
        delete $scope.notes[note.i];
    };
    
    $scope.deleteAllNotes = function() {
        if (!confirm('Really delete all notes?')) return;
        angular.forEach($scope.notes, function(note, index) {
            $scope.deleteNote(note);
        });
        $scope.nextNoteId = 1;
    };

    $scope.workspaces = ['inbox', 'trash'];
    
    $scope.saveWorkspace = function() {
        $scope.saveNote($scope.workspace);        
    };

    $scope.toggleText = function(note) {
        if (note.d) delete note.d;
        else note.d = 1;
        $scope.saveNote(note);
    };

    // mouse pointer indication
    $scope.mouseover = function(note, event) {
        if ($scope.inResizeZone(note, event)) {
            note._resizable = 1;
        }
        else delete note._resizable;
    };
    $scope.mouseleave = function(note, event) {
        delete note._resizable;
    };

    // drag and drop
    $scope.stopEvent = function(event) {
        var e = event.originalEvent;
        if (e.preventDefault) {
            e.preventDefault();     // Necessary. Allows us to drop.
        }
    };

    $scope.resizeMargin = 36;
    $scope.inResizeZone = function(note, event) {
        var e = event.originalEvent;
        return (e.offsetX > (note.w - $scope.resizeMargin));
    };

    $scope.drag = {};

    $scope.dragstart = function(event) {
        if ($scope.drag.active) return;
        var e = event.originalEvent;
        angular.extend($scope.drag, {
            offsetX: e.offsetX,
            offsetY: e.offsetY,
            noteElement: e.target,
            active: true,
        });

        // e.DataTransfer here
        e.dataTransfer.dropEffect = 'move';
        e.dataTransfer.effectAllowed = 'move';

        var id = $scope.drag.noteElement.id;
        if (!id.match(/^note_/)) alert('Bogus note id');
        $scope.drag.noteId = id.slice(5);

        var note = $scope.notes[$scope.drag.noteId];
        if ($scope.inResizeZone(note, event)) {
            e.dataTransfer.setDragImage(angular.element('.dragImage')[0], 0, 0);
            $scope.drag.resize = true;
            $scope.drag.startingWidth = note.w;
        }
        else {
            $scope.drag.noteElement.style.opacity = 0.4;
            $scope.drag.resize = false;
        }
    };
    $scope.dragover = function(event) {
        //console.log('dragover', event);
        $scope.stopEvent(event);
        return false;
    };
    $scope.dragenter = function(event) {
        // this / e.target is the current hover target.
        //event.originalEvent.target.classList.add('over');
        //console.log('dragenter:', event);
        $scope.stopEvent(event);
        return false;
    };
    $scope.dragleave = function(event) {
        //event.originalEvent.target.classList.remove('over');
        //console.log('dragleave', event);
    };
    $scope.dragging = function(event) {
        if ($scope.drag.resize) {
            var e = event.originalEvent;
            var delta = e.offsetX - $scope.drag.offsetX;
            var newWidth = $scope.drag.startingWidth + delta;
            if (newWidth < 48) newWidth = 48;
            $scope.notes[$scope.drag.noteId].w = newWidth;
        }
        //console.log('drag', event); 
    };
    $scope.drop = function(event) {
        $scope.stopEvent(event);
        if (!$scope.drag.active) return;
        $scope.drag.noteElement.style.opacity = 1.0;
        var e = event.originalEvent;
        var target = e.target;
        var id = target.id;
        if ($scope.drag.resize) {
            $scope.saveNote($scope.notes[$scope.drag.noteId]);
            $scope.drag = {};
        }
        else if (!id.match(/^note_/)) {  // drop on workspace
            $scope.notes[$scope.drag.noteId].x = e.x - $scope.drag.offsetX + $window.pageXOffset;
            $scope.notes[$scope.drag.noteId].y = e.y - $scope.drag.offsetY + $window.pageYOffset;
            $scope.saveNote($scope.notes[$scope.drag.noteId]);
            $scope.drag = {};
        }
        else {        
            // TODO: drop on note
            $scope.drag = {};
            return false;
            var droppedNoteId = id.slice(5);
            console.log('dropped on note', droppedNoteId);
            $scope.notes[droppedNoteId].t += [
                '<p>', $scope.notes[$scope.draggedNoteId].n, '</p>\n',
                '<p>', $scope.notes[$scope.draggedNoteId].t, '</p>'
            ].join('');
        }
        return false;
    };
    $scope.dragend = function(event) { 
       // this/e.target is the source node.
        var e = event.originalEvent;
        //console.log('dragend', event);  
        return false;
    };

    $scope.nextX = 24;
    $scope.nextY = 24;
    $scope.nextIncrement = 24;
    $scope.nextXPos = function() {
        $scope.nextX += $scope.nextIncrement;
        return $scope.nextX;
    };
    $scope.nextYPos = function() {
        $scope.nextY += $scope.nextIncrement;
        return $scope.nextY;
    };

    // add note via command bar
    $scope.addNoteFromForm = function() {
        // called from commandBar form, so 'this' is $scope here
        if (this.newNoteText[0] == '.') {           // command
            try {
                eval('$scope.' + this.newNoteText.slice(1));
            } catch(e) {
                console.log('Error:', e);
            }
            this.newNoteText = '';
        }
        else if (this.newNoteText[0] == '{') {     // json note
            var newNote = JSON.parse(this.newNoteText);
            newNote.i = $scope.newNoteId();
            $scope.updateNote(newNote);
            $scope.saveNote($scope.notes[newNote.i]);
            this.newNoteText = '';            
        }
        else if (this.isUrl.test(this.newNoteText)) {   // image note
            var newNote = {};
            angular.extend(newNote, {
                i: this.newNoteId(),
                d: 1,
                t: this.newNoteText,
                x: this.nextXPos(),
                y: this.nextYPos()
            });
            this.updateNote(newNote);
            this.saveNote(this.notes[newNote.i]);
            this.newNoteText = '';            
        }
        else {
            if (this.newNoteText.length == 0) return;
            var lines = this.newNoteText.split('/');
            var newNote = {
                i: $scope.newNoteId(),
                n: lines[0],
                x: $scope.nextXPos(),
                y: $scope.nextYPos()
            };
            if (lines.length > 1) {
                // html in the body: replace the slashes
                if (lines[1][0] == '<') newNote.t = lines.slice(1).join('/');
                else newNote.t = lines.slice(1).join('\n');
                newNote.d = 1;
            }
            this.updateNote(newNote);
            this.saveNote(this.notes[newNote.i]);
            this.newNoteText = '';
        }
    };

    // edit title of note
    $scope.editTitle = function(note) {
        note._saved_title = note.n;
        note._editingTitle = 1;
    };
    $scope.cancelEditTitle = function(note) {
        note.n = note._saved_title;
        delete note._saved_title;
        delete note._editingTitle;
    };
    $scope.saveTitle = function(note) {
        delete note._saved_title;   // could keep this for undo
        delete note._editingTitle;
        $scope.saveNote(note);
    };

    // edit text of note
    $scope.editText = function(note) {
        note._saved_text = note.t;
        note.d = 1;
        note._editingText = 1;
    };
    $scope.cancelEditText = function(note) {
        note.t = note._saved_text;
        delete note._saved_text;
        delete note._editingText;
    };
    $scope.saveText = function(note) {
        delete note._saved_text;   // could keep this for undo
        delete note._editingText;
        $scope.saveNote(note);
    };

    $scope.duplicateNote = function(note) {
        var newNote = {};
        angular.extend(newNote, note);
        angular.extend(newNote, {
            i: $scope.newNoteId(),
            x: newNote.x + 24,
            y: newNote.y + 24
        });
        $scope.updateNote(newNote);
        $scope.saveNote(newNote);
    };

    $scope.isUrl = /^(http:|https:)/;
    $scope.isImg = /(.jpg|.jpeg|.png|.gif|.tiff)$/;

    $scope.renderBody = function(note) {
        if (!note.t) return '';
        if ($scope.isUrl.test(note.t)) {    // image url
            if ($scope.isImg.test(note.t)) {
                return '<img src="' + note.t + '" width="' + note.w + '"/>';
            }
        }
        if (note.t[0] == '<') return note.t;    // html body
        var lines = note.t.split('\n');
        return '<p>' + lines.join('</p>\n<p>') + '</p>';    // else htmlify body
    };

    $scope.noteMenu = [
        {t:'Edit Note Body',        x:'editText(selectedNote);hideMenu()'},
        {t:'Edit Note Title',       x:'editTitle(selectedNote);hideMenu()'},
        {s:1},
        {t:'Set Text Color',        x:'setNoteColor("c", selectedNote, $event);hideMenu()'},
        {t:'Set Background Color',  x:'setNoteColor("b", selectedNote, $event);hideMenu()'},
        {s:1},
        {t:'Duplicate Note',        x:'duplicateNote(selectedNote);hideMenu()'},
        {s:1},
        {t:'Delete Note',           x:'deleteNote(selectedNote);hideMenu()'},
        {t:'Delete All Notes',      x:'deleteAllNotes();hideMenu()'},
        {s:1},
        {t:'Set Workspace Background',  x:'setWorkspaceColor("b", workspace, $event);hideMenu()'}       
    ];

    $scope.showNoteMenu = function(note, event) {
        $scope.selectedNote = note;
        $scope.showingNoteMenu = true;
        $scope.menuX = event.clientX;
        $scope.menuY = event.clientY;
        angular.element('.noteMenu').css({
            left: $scope.menuX,
            top: $scope.menuY
        });
    };

    $scope.pickedColor = '';

    $scope.showColorPicker = function(event) {
        $scope.showingColorPicker = true;
        angular.element('.colorPickerPlaceholder').click();
        angular.element('.colorpicker').css({
            left: $scope.menuX,
            top: $scope.menuY
        });        
    };

    $scope.isColorPickerVisible = function() {
        return $('.colorpicker-visible').length > 0;
    };

    $scope.setNoteColor = function(attr, note, event) {
        $scope.setObjectColor(attr, note, event, function(note) {
            $scope.saveNote(note);
        });
    };

    $scope.setWorkspaceColor = function(attr, obj, event) {
        $scope.setObjectColor(attr, obj, event, function(workspace) {
            $scope.saveWorkspace();
        });
    };
    
    $scope.setObjectColor = function(attr, obj, event, callback) {
        $scope.pickedColor = obj[attr];
        $scope.showColorPicker(event);

        // watch pickedColor and update note[attr]
        var colorWatch = $scope.$watch('pickedColor', function(newValue, oldValue) {
            if (newValue === oldValue) return;
            obj[attr] = newValue;
        });

        // watch isColorPickerVisible to become false and saveNote 
        var colorPickerWatch = $scope.$watch('isColorPickerVisible()', function(newValue, oldValue) {
            if (oldValue == true && newValue == false) {
                if (callback) callback(obj);
                colorWatch();       // stop watching: call the remove() function
                colorPickerWatch();
            }
        });
    };

    $scope.hideMenu = function() {
        delete $scope.showingNoteMenu;
        delete $scope.selectedNote;
        delete $scope.showingColorPicker;
        delete $scope.selectedAttr;
    };

};
</script>

</body>
</html>
